package systems.vos.wisey.compiler.tests;

import wisey.lang.CCallStack;
import wisey.lang.IProgram;
import wisey.lang.IProducerThread;
import wisey.lang.IThread;
import wisey.lang.TDefaultProducer;

model MProducerResult {
  int mResult;

  public int getResult() {
    return mResult;
  }
}

thread TProducer implements IProducerThread {
  inject TDefaultProducer* mDefaultProducer;
  receive int mSize;

  public void produce() {
    IThread.sleep(1);
    printout("This is producer thread!\n");
    for (int i = 0; i < 2; i++) {
      MProducerResult* result = builder(MProducerResult).withResult(i).build();
      printout("Adding result " + i + "\n");
      result = thread.send(result);
      while (result != null) {
        printout("Could not add result " + i + ", sleeping\n");
        IThread.sleep(1);
        result = thread.send(result);
      }
    }
  }

  public void start() {
    mDefaultProducer.startProducer(this, mSize);
  }

  public boolean hasStarted() {
    return mDefaultProducer.hasStarted();
  }

  public boolean hasResult() {
    return mDefaultProducer.hasResult();
  }

  public boolean wasCancelled() {
    return mDefaultProducer.wasCancelled();
  }

  public void cancel() {
    mDefaultProducer.cancel();
  }

  public ::llvm::object* consume() {
    return mDefaultProducer.consume();
  }

  public ::llvm::object* send(::llvm::object* message) {
    return mDefaultProducer.send(message);
  }

  public CCallStack getCallStack() {
    return mDefaultProducer.getCallStack();
  }
}

controller CProgram implements IProgram {
  inject TProducer* mProducer.withSize(3);

  public int run() {
    printout("Thread started = " + mProducer.hasStarted() + ", has result = " + mProducer.hasResult() + "\n");
    printout("Starting producer thread\n");
    mProducer.start();
    printout("Producer thread started\n");
    printout("Thread started = " + mProducer.hasStarted() + ", has result = " + mProducer.hasResult() + "\n");
    IThread.sleep(2);
    while (mProducer.hasResult()) {
      int result = ((MProducerResult) mProducer.consume()).getResult();
      printout("Producer thread finished with result: " + result + "\n");
      printout("Thread started = " + mProducer.hasStarted() + ", has result = " + mProducer.hasResult() + "\n");
      IThread.sleep(1);
    }
    mProducer.cancel();
    return 0;
  }
}

bind(IProgram).to(CProgram);
